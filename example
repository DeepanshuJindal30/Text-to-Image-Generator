
namespace PES.WebAPI.Models
{
    public class SPModel
    {
        public string Name { get; set; }="";
        public string Service_Type { get; set; } = "";
        public int Trustee_ID { get; set; }
    }
}

USE PES
/*Database Design (Manual Tables)*/
CREATE TABLE Deepanshu_AML (
    AML_ID INT IDENTITY(1,1) PRIMARY KEY,
    Plan_Number VARCHAR(20) NOT NULL,
    Status VARCHAR(50) NOT NULL,
    Compliance_Date DATETIME NOT NULL,
    Comments VARCHAR(255) NULL,
    Created_On DATETIME DEFAULT GETDATE()
);
CREATE TABLE Deepanshu_Trustee (
    Trustee_ID INT IDENTITY(1,1) PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Email VARCHAR(100) NOT NULL,
    Phone VARCHAR(20) NULL,
    Plan_Number VARCHAR(20) NOT NULL,
    Created_On DATETIME DEFAULT GETDATE()
);
CREATE TABLE Deepanshu_SP (
    SP_ID INT IDENTITY(1,1) PRIMARY KEY,
    Name VARCHAR(100) NOT NULL,
    Service_Type VARCHAR(50) NOT NULL,
    Trustee_ID INT NOT NULL,
    Created_On DATETIME DEFAULT GETDATE(),
    FOREIGN KEY (Trustee_ID) REFERENCES Deepanshu_Trustee(Trustee_ID)
);

INSERT INTO Deepanshu_Trustee (Name, Email, Phone, Plan_Number)
VALUES
('John Trustee', 'john@example.com', '9876543210', 'P123'),
('Mary Trustee', 'mary@example.com', '9988776655', 'P124');
INSERT INTO Deepanshu_AML (Plan_Number, Status, Compliance_Date, Comments)
VALUES
('P123', 'Compliant', GETDATE(), 'No issues'),
('P124', 'Pending', GETDATE(), 'Audit scheduled');
INSERT INTO Deepanshu_SP (Name, Service_Type, Trustee_ID)
VALUES
('Service Partner A', 'Investment', 2),
('Service Partner B', 'Consulting', 4);


SELECT * FROM Deepanshu_AML WITH (NOLOCK);
SELECT * FROM Deepanshu_Trustee WITH (NOLOCK);
SELECT * FROM Deepanshu_SP WITH (NOLOCK);

/*PART 1: SQL CRUD QUERIES (with NOLOCK)*/

INSERT INTO Deepanshu_AML (Plan_Number, Status, Compliance_Date, Comments)
VALUES ('PLAN123', 'Approved', GETDATE(), 'AML verified');

SELECT * 
FROM Deepanshu_AML WITH (NOLOCK);

UPDATE Deepanshu_AML
SET Status = 'Pending', Comments = 'Verification required'
WHERE AML_ID = 1;

DELETE FROM Deepanshu_AML
WHERE AML_ID = 1;

/*Trustee Table (Deepanshu_Trustee)
Insert*/
INSERT INTO Deepanshu_Trustee (Name, Email, Phone, Plan_Number)
VALUES ('John Doe', 'john@example.com', '9876543210', 'PLAN123');

SELECT * 
FROM Deepanshu_Trustee WITH (NOLOCK);

UPDATE Deepanshu_Trustee
SET Email = 'john.doe@trustee.com'
WHERE Trustee_ID = 1;

DELETE FROM Deepanshu_Trustee
WHERE Trustee_ID = 1;

/*3. SP Table (Deepanshu_SP)*/

INSERT INTO Deepanshu_SP (Name, Service_Type, Trustee_ID)
VALUES ('ABC Services', 'Auditing', 1);

SELECT * 
FROM Deepanshu_SP WITH (NOLOCK);

UPDATE Deepanshu_SP
SET Service_Type = 'Advisory'
WHERE SP_ID = 1;

DELETE FROM Deepanshu_SP
WHERE SP_ID = 1;



/*FOR AUTHENTICATION*/

CREATE TABLE Deepanshu_Users (
    User_ID INT IDENTITY(1,1) PRIMARY KEY,
    Username VARCHAR(50) UNIQUE NOT NULL,
    PasswordHash VARCHAR(255) NOT NULL,
    Role VARCHAR(50) NOT NULL,
    Created_On DATETIME DEFAULT GETDATE()
);
SELECT * FROM Deepanshu_Users
INSERT INTO Deepanshu_Users (Username, PasswordHash, Role)
VALUES 
('admin', 'admin123', 'Admin'),
('manager', 'manager123', 'Manager');
INSERT INTO AspNetRoles (Id,Name,NormalizedName,ConcurrencyStamp)
VALUES 
(NEWID(), 'Admin', 'ADMIN',NEWID()),
(NEWID(), 'User', 'User',NEWID()),
(NEWID(), 'Manager', 'Manager',NEWID());

SELECT * FROM Deepanshu_Users

SELECT * FROM AspNetUsers

SELECT * FROM AspNetRoles

SELECT * FROM AspNetUserRoles


/*Identity Authentication*/
CREATE TABLE AspNetUsers (
    Id NVARCHAR(450) PRIMARY KEY,
    UserName NVARCHAR(256) NULL,
    NormalizedUserName NVARCHAR(256) NULL,
    Email NVARCHAR(256) NULL,
    NormalizedEmail NVARCHAR(256) NULL,
    EmailConfirmed BIT NOT NULL DEFAULT 0,
    PasswordHash NVARCHAR(MAX) NULL,
    SecurityStamp NVARCHAR(MAX) NULL,
    ConcurrencyStamp NVARCHAR(MAX) NULL,
    PhoneNumber NVARCHAR(MAX) NULL,
    PhoneNumberConfirmed BIT NOT NULL DEFAULT 0,
    TwoFactorEnabled BIT NOT NULL DEFAULT 0,
    LockoutEnd DATETIMEOFFSET NULL,
    LockoutEnabled BIT NOT NULL DEFAULT 1,
    AccessFailedCount INT NOT NULL DEFAULT 0
);

CREATE TABLE AspNetRoles (
    Id NVARCHAR(450) PRIMARY KEY,
    Name NVARCHAR(256) NULL,
    NormalizedName NVARCHAR(256) NULL,
    ConcurrencyStamp NVARCHAR(MAX) NULL
);

CREATE TABLE AspNetUserRoles (
    UserId NVARCHAR(450) NOT NULL,
    RoleId NVARCHAR(450) NOT NULL,
    PRIMARY KEY (UserId, RoleId),
    FOREIGN KEY (UserId) REFERENCES AspNetUsers (Id) ON DELETE CASCADE,
    FOREIGN KEY (RoleId) REFERENCES AspNetRoles (Id) ON DELETE CASCADE
);


INSERT INTO AspNetRoles (Id, Name, NormalizedName)
VALUES ('1', 'Admin', 'ADMIN'), ('2', 'User', 'USER');
INSERT INTO AspNetUsers (Id, UserName, NormalizedUserName, Email, NormalizedEmail, PasswordHash, EmailConfirmed)
VALUES ('100', 'admin', 'ADMIN', 'admin@example.com', 'ADMIN@EXAMPLE.COM',
'$2a$11$uK9m9rDPO...<HASHED_PASSWORD>', 1);
INSERT INTO AspNetUserRoles (UserId, RoleId)
VALUES ('100', '1');


DELETE FROM AspNetRoles
DELETE FROM AspNetUsers
DELETE FROM AspNetUserRoles

SELECT Id, UserName FROM AspNetUsers
SELECT Id, Name FROM AspNetRoles

INSERT INTO AspNetUserRoles(UserId,RoleId)
VALUES ('<UserId>','<RoleId>')

/*Pagination*/

-- Pagination for AML Table
DECLARE @PageNumber INT = 1;
DECLARE @PageSize INT = 10;

SELECT *
FROM Deepanshu_AML WITH (NOLOCK)
ORDER BY AML_ID
OFFSET (@PageNumber - 1) * @PageSize ROWS
FETCH NEXT @PageSize ROWS ONLY;

-- Total count
SELECT *
FROM Deepanshu_AML WITH (NOLOCK)
ORDER BY AML_ID



-- Pagination for Trustee Table

DECLARE @PageNumber INT = 1;
DECLARE @PageSize INT = 10;
SELECT *
FROM Deepanshu_Trustee WITH (NOLOCK)
ORDER BY Trustee_ID
OFFSET (@PageNumber - 1) * @PageSize ROWS
FETCH NEXT @PageSize ROWS ONLY;

-- Total count
SELECT COUNT(*) FROM Deepanshu_Trustee WITH (NOLOCK);


-- Pagination for Service Provider Table

DECLARE @PageNumber INT = 1;
DECLARE @PageSize INT = 10;
SELECT *
FROM Deepanshu_SP WITH (NOLOCK)
ORDER BY SP_ID
OFFSET (@PageNumber - 1) * @PageSize ROWS
FETCH NEXT @PageSize ROWS ONLY;

-- Total count
SELECT COUNT(*) FROM Deepanshu_SP WITH (NOLOCK);
// using Dapper;
// using Microsoft.AspNetCore.Mvc;
// using PES.WebAPI.Data;
// using PES.WebAPI.Models;

// [ApiController]
// [Route("api/[controller]")]
// public class SPController : ControllerBase
// {
//     private readonly DapperContext _context;

//     public SPController(DapperContext context)
//     {
//         _context = context;
//     }

//     [HttpPost]
//     public async Task<IActionResult> Create([FromBody] SPModel model)
//     {    using var conn = _context.CreateConnection();
        

//         var sql = @"INSERT INTO Deepanshu_SP (Name, Service_Type, Trustee_ID)
//                     VALUES (@Name, @Service_Type, @Trustee_ID)";

//         await conn.ExecuteAsync(sql, model);

//         return Ok("SP record inserted successfully");
//     }

//     [HttpGet]
//     public async Task<IActionResult> GetAll()
//     {
//         var sql = "SELECT * FROM Deepanshu_SP WITH (NOLOCK)";
//         using var conn = _context.CreateConnection();
//         var data = await conn.QueryAsync(sql);
//         return Ok(data);
//     }
// }

using Microsoft.AspNetCore.Mvc;
using Dapper;
using PES.WebAPI.Data;
using PES.WebAPI.Models;

[ApiController]
[Route("api/[controller]")]
public class SPController : ControllerBase
{
    private readonly DapperContext _context;

    public SPController(DapperContext context)
    {
        _context = context;
    }

    // ➡ CREATE (POST)
    [HttpPost]
    public async Task<IActionResult> Create([FromBody] SPModel model)
    {
        using var conn = _context.CreateConnection();

        // Validate Trustee_ID exists
        var trusteeExists = await conn.ExecuteScalarAsync<int>(
            "SELECT COUNT(1) FROM Deepanshu_Trustee WHERE Trustee_ID = @Trustee_ID",
            new { Trustee_ID = model.Trustee_ID }
        );

        if (trusteeExists == 0)
        {
            return BadRequest($"Trustee_ID {model.Trustee_ID} does not exist.");
        }

        var sql = @"INSERT INTO Deepanshu_SP (Name, Service_Type, Trustee_ID)
                    VALUES (@Name, @Service_Type, @Trustee_ID)";

        await conn.ExecuteAsync(sql, model);

        return Ok("SP record inserted successfully");
    }

    // ➡ READ (GET All)
    [HttpGet]
    public async Task<IActionResult> GetAll()
    {
        using var conn = _context.CreateConnection();
        var sql = "SELECT * FROM Deepanshu_SP WITH (NOLOCK)";
        var data = await conn.QueryAsync(sql);
        return Ok(data);
    }

    // ➡ READ (GET by ID)
    [HttpGet("{id}")]
    public async Task<IActionResult> GetById(int id)
    {
        using var conn = _context.CreateConnection();
        var sql = "SELECT * FROM Deepanshu_SP WITH (NOLOCK) WHERE SP_ID = @SP_ID";
        var sp = await conn.QueryFirstOrDefaultAsync(sql, new { SP_ID = id });

        if (sp == null)
            return NotFound($"SP record with ID {id} not found.");

        return Ok(sp);
    }

    // ➡ UPDATE (PUT)
    [HttpPut("{id}")]
    public async Task<IActionResult> Update(int id, [FromBody] SPModel model)
    {
        using var conn = _context.CreateConnection();

        // Check if SP record exists
        var exists = await conn.ExecuteScalarAsync<int>(
            "SELECT COUNT(1) FROM Deepanshu_SP WHERE SP_ID = @SP_ID", new { SP_ID = id });

        if (exists == 0)
            return NotFound($"SP record with ID {id} not found.");

        // Check Trustee_ID exists
        var trusteeExists = await conn.ExecuteScalarAsync<int>(
            "SELECT COUNT(1) FROM Deepanshu_Trustee WHERE Trustee_ID = @Trustee_ID",
            new { Trustee_ID = model.Trustee_ID });

        if (trusteeExists == 0)
            return BadRequest($"Trustee_ID {model.Trustee_ID} does not exist.");

        var sql = @"UPDATE Deepanshu_SP 
                    SET Name = @Name, Service_Type = @Service_Type, Trustee_ID = @Trustee_ID 
                    WHERE SP_ID = @SP_ID";

        await conn.ExecuteAsync(sql, new
        {
            model.Name,
            model.Service_Type,
            model.Trustee_ID,
            SP_ID = id
        });

        return Ok($"SP record with ID {id} updated successfully");
    }

    // ➡ DELETE
    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(int id)
    {
        using var conn = _context.CreateConnection();

        var sql = "DELETE FROM Deepanshu_SP WHERE SP_ID = @SP_ID";
        var rows = await conn.ExecuteAsync(sql, new { SP_ID = id });

        if (rows == 0)
            return NotFound($"SP record with ID {id} not found.");

        return Ok($"SP record with ID {id} deleted successfully");
    }
}
import React, { useEffect, useState } from "react";
import api from "../api";
import {
  Button,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  Container,
  TextField,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  TablePagination,
} from "@mui/material";

export default function SPList() {
  const [spList, setSpList] = useState([]);
  const [form, setForm] = useState({
    name: "",
    serviceType: "",
    trusteeId: "",
  });
  const [open, setOpen] = useState(false);
  const [editId, setEditId] = useState(null);
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(10);

  const fetchSP = async () => {
    const res = await api.get("/sp");
    setSpList(res.data);
  };

  useEffect(() => {
    fetchSP();
  }, []);

  const handleSave = async () => {
    if (editId) {
      await api.put(`/sp/${editId}`, form);
    } else {
      await api.post("/sp", form);
    }
    fetchSP();
    setOpen(false);
    setForm({ name: "", serviceType: "", trusteeId: "" });
    setEditId(null);
  };

  const handleEdit = (sp) => {
    setForm({
      name: sp.name || sp.Name,
      serviceType: sp.service_Type || sp.Service_Type,
      trusteeId: sp.trustee_ID || sp.Trustee_ID,
    });
    setEditId(sp.sp_ID || sp.SP_ID);
    setOpen(true);
  };

  const handleDelete = async (id) => {
    await api.delete(`/sp/${id}`);
    fetchSP();
  };

  const filtered = spList.filter((sp) =>
    (sp.name || sp.Name || "")
      .toLowerCase()
      .includes(search.toLowerCase())
  );

  return (
    <Container>
      <h2>Service Provider Records</h2>
      <Button variant="contained" onClick={() => setOpen(true)}>
        Add SP
      </Button>
      <TextField
        label="Search by Name"
        size="small"
        style={{ margin: "10px" }}
        value={search}
        onChange={(e) => setSearch(e.target.value)}
      />

      <div style={{ maxHeight: "400px", overflow: "auto" }}>
        <Table stickyHeader>
          <TableHead>
            <TableRow>
              <TableCell>SP_ID</TableCell>
              <TableCell>Name</TableCell>
              <TableCell>Service Type</TableCell>
              <TableCell>Trustee_ID</TableCell>
              <TableCell>Actions</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {filtered.length > 0 ? (
              filtered
                .slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage)
                .map((sp) => (
                  <TableRow key={sp.sp_ID || sp.SP_ID}>
                    <TableCell>{sp.sp_ID || sp.SP_ID}</TableCell>
                    <TableCell>{sp.name || sp.Name}</TableCell>
                    <TableCell>
                      {sp.service_Type || sp.Service_Type}
                    </TableCell>
                    <TableCell>{sp.trustee_ID || sp.Trustee_ID}</TableCell>
                    <TableCell>
                      <Button onClick={() => handleEdit(sp)}>Edit</Button>
                      <Button
                        color="error"
                        onClick={() => handleDelete(sp.sp_ID || sp.SP_ID)}
                      >
                        Delete
                      </Button>
                    </TableCell>
                  </TableRow>
                ))
            ) : (
              <TableRow>
                <TableCell colSpan={5} align="center">
                  No records found
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <TablePagination
        rowsPerPageOptions={[5, 10, 25]}
        component="div"
        count={filtered.length}
        rowsPerPage={rowsPerPage}
        page={page}
        onPageChange={(e, newPage) => setPage(newPage)}
        onRowsPerPageChange={(e) => {
          setRowsPerPage(parseInt(e.target.value, 10));
          setPage(0);
        }}
      />

      {/* Modal Form */}
      <Dialog open={open} onClose={() => setOpen(false)}>
        <DialogTitle>{editId ? "Edit Service Provider" : "Add Service Provider"}</DialogTitle>
        <DialogContent>
          <TextField
            fullWidth
            label="Name"
            margin="normal"
            value={form.name}
            onChange={(e) => setForm({ ...form, name: e.target.value })}
          />
          <TextField
            fullWidth
            label="Service Type"
            margin="normal"
            value={form.serviceType}
            onChange={(e) => setForm({ ...form, serviceType: e.target.value })}
          />
          <TextField
            fullWidth
            label="Trustee ID"
            margin="normal"
            value={form.trusteeId}
            onChange={(e) => setForm({ ...form, trusteeId: e.target.value })}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpen(false)}>Cancel</Button>
          <Button variant="contained" onClick={handleSave}>
            Save
          </Button>
        </DialogActions>
      </Dialog>
    </Container>
  );
}
