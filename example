IdentityUser user;

if (model.UsernameOrEmail.Contains("@"))
{
    user = await _userManager.FindByEmailAsync(model.UsernameOrEmail);
}
else
{
    user = await _userManager.FindByNameAsync(model.UsernameOrEmail);
}

if (user == null)
    return Unauthorized("User not found");

var result = await _signInManager.CheckPasswordSignInAsync(user, model.Password, false);
if (!result.Succeeded)
    return Unauthorized("Invalid credentials");

// Rest of the token logic stays the same